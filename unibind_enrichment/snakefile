configfile: "./config.yaml"

# Reading stuff formt he config file.
qvalues = config['qvalues']
tmp_folder = config['tmp_folder']
clusters_folder = config['clusters_folder']
features = config["features"]
fantom5_peak_types = config["fantom5_peak_types"]
tss_radius = config["tss_radius"]

tss_name = f"tss_{tss_radius}bp"

def red(text):
    return "\033[1;31m" + text + "\033[0m"

rule clus_to_bed:
    input:
        script = "../analysis/clus_io.py",
        clus = tmp_folder + "/" + "_qvalues.clus"
    output: 
        bed = temp(tmp_folder + "/" + "_qvalues.bed")
    shell:
        "python {input.script} clus2bed" f" {clusters_folder}" " {input.clus} {output.bed}"


#This rule transform whatever is the q values into a clus file.
rule tsv_to_clus:
    input:
        script = "../analysis/clus_io.py",
        qvalues = qvalues
    output: 
        clus = temp(tmp_folder + "/" + "_qvalues.clus")
    shell:
        "python {input.script} tsv2clus {input.qvalues} {output.clus}"


#This rule intersects the clusters ranges with the features (features active in the given cell line).
rule intersect_clusters:
    input:
        script = "../analysis/bed_utils.py",
        bed = tmp_folder + "/" + "_qvalues.bed",
        features = features
    output:
        inside = temp(tmp_folder + "/" + "_inside.bed"),

    shell:
        "python {input.script} intersect" " {input.features} {input.bed} {output.inside}"

# This rule filters the features to the ones which have a correspondent entry in the FANTOM5 data
rule get_foreground_types:
    input: 
        script = "../analysis/fantom5_utils.py",
        inside = tmp_folder + "/" + "_inside.bed",
        peak_types = fantom5_peak_types
    output:
        filtered = temp(tmp_folder + "/" + "_inside.types")
    shell:
        "python {input.script} filter" " {input.inside} {input.peak_types} {output.filtered}"

# This rule filters the background features to the ones which have a correspondent entry in the FANTOM5 data
rule get_background_types:
    input: 
        script = "../analysis/fantom5_utils.py",
        features = features,
        peak_types = fantom5_peak_types
    output:
        background_filtered = temp(tmp_folder + "/" + "_background.types")
    shell:
        "python {input.script} filter" " {input.features} {input.peak_types} {output.background_filtered}"


# This rule creates the background.
rule get_enhancers:
    input:
        script = "../analysis/fantom5_utils.py",
        filtered = tmp_folder + "/" + "_inside.types"
    output:
        enhancers = temp(tmp_folder + "/" + "_enhancers.bed"),
    shell:
        "python {input.script} getRanges enhancer " " {input.filtered} {output.enhancers}"

rule get_enhancers_background:
    input:
        script = "../analysis/fantom5_utils.py",
        background_filtered = tmp_folder + "/" + "_background.types"
    output:
        background = temp(tmp_folder + "/" + "_enhancers_background.bed")
    shell:
        "python {input.script} background enhancer " " {input.background_filtered} {output.background}"


rule get_tss:
    input:
        script = "../analysis/fantom5_utils.py",
        filtered = tmp_folder + "/" + "_inside.types"
    output:
        tss = temp(tmp_folder + "/" + f"_{tss_name}.bed")
    shell:
        "python {input.script} getRanges tss " " {input.filtered} {output.tss} "  f"{tss_radius}"


rule get_tss_background:
    input:
        script = "../analysis/fantom5_utils.py",
        background_filtered = tmp_folder + "/" + "_background.types"
    output:
        background = temp(tmp_folder + "/" + f"_{tss_name}_background.bed")
    shell:
        "python {input.script} background tss " " {input.background_filtered} {output.background} " f"{tss_radius}"

rule all:
    input:
        # All the files.
        files = [
            tmp_folder + "/" + f"_{tss_name}.bed", 
            tmp_folder + "/" + f"_{tss_name}_background.bed", 
            tmp_folder + "/" + "_enhancers.bed", 
            tmp_folder + "/" + "_enhancers_background.bed"
            ],
        # The script to use.
        lift_over_script = "../analysis/lift_over.py",
        filter_script = "../analysis/bed_utils.py"
    output:
        files = [
            tmp_folder + "/" + f"{tss_name}.bed", 
            tmp_folder + "/" + f"{tss_name}_background.bed", 
            tmp_folder + "/" + "enhancers.bed", 
            tmp_folder + "/" + "enhancers_background.bed"
            ],

    run:
        for i in range(len(input.files)):
            f = input.files[i]
            o = output.files[i]
            # filter
            shell("python {input.filter_script} keepAutosomal " f"{f}" f" {o}")

            # lift over
            shell("python {input.lift_over_script} " f" {f} hg19 hg38 {o}")